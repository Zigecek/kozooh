<!DOCTYPE html>
<html lang="CZ-cs">
  <head>
    <meta charset="UTF-8" />
    <title>Kozooh - Vytváření předlohy</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    />
  </head>

  <body>
    <div class="position-fixed end-0" id="alerts"></div>
    <div class="container">
      <h1 class="text-center fs-1 m-3">Vytvořit předlohu</h1>
      <div class="input-lg">
        <input
          id="template-name"
          type="text"
          class="form-control m-2"
          placeholder="Název"
        />
        <input
          id="template-show"
          type="checkbox"
          class="form-check-input m-2"
        />
        <label class="form-check-label m-2" for="template-show"
          >Zobrazovat otázky u hráčů</label
        >

        <input
          id="template-pause"
          type="checkbox"
          class="form-check-input m-2"
        />
        <label class="form-check-label m-2" for="template-pause"
          >Zobrazovat skóre mezi koly</label
        >

        <input
          id="question-time"
          type="number"
          class="form-control m-2"
          placeholder="Délka kola (vteřin)"
        />
      </div>
      <!-- Seznam otázek -->
      <h2 class="fs-3 m-3">Otázky</h2>
      <ul id="question-list" class="m-2 list-group">
        <!-- DYNAMICKÉ -->
        <!-- Otázka 1 -->
        <li id="q-0-body" class="list-group-item">
          <div class="d-flex bd-highlight">
            <div class="align-self-center p-2 flex-grow-1 bd-highlight">
              <input
                id="q-0"
                type="text"
                class="form-control"
                placeholder="Otázka"
              />
              <!-- Odpovědi -->
              <h2 class="fs-5 m-3">Odpovědi</h2>
              <ul id="q-0-list" class="m-2 list-group">
                <!-- Odpověď 1 -->
                <li id="a-0-0-body" class="list-group-item">
                  <div class="d-flex bd-highlight">
                    <div class="align-self-center p-2 flex-grow-1 bd-highlight">
                      <input
                        id="a-0-0"
                        type="text"
                        class="form-control"
                        placeholder="Odpověď"
                      />
                      <div class="m-3 form-check">
                        <input
                          id="a-0-0-correct"
                          type="checkbox"
                          class="form-check-input"
                        />
                        <label class="form-check-label" for="a-0-0-correct"
                          >Správná odpověď</label
                        >
                      </div>
                    </div>
                    <div class="align-self-center p-2 bd-highlight">
                      <button
                        onclick="deleteAnswer(0, 0)"
                        class="m-2 btn btn-sm btn-danger"
                      >
                        Smazat
                      </button>
                    </div>
                  </div>
                </li>
              </ul>
              <!-- Nová odpověď -->
              <button class="btn btn-sm btn-primary" onclick="newAnswer(0)">
                Nová odpověď
              </button>
            </div>
            <div class="align-self-center p-2 bd-highlight">
              <button
                onclick="deleteQuestion(0)"
                class="m-2 btn btn-sm btn-danger"
              >
                Smazat
              </button>
            </div>
          </div>
        </li>
        <!-- // DYNAMICKÉ // -->
      </ul>
      <!-- Nová otázka -->
      <button class="btn btn-sm btn-primary" onclick="newQuestion()">
        Nová otázka
      </button>
      <br />
      <button class="m-3 btn btn-lg btn-primary" onclick="createTemplate()">
        Vytvořit předlohu
      </button>
    </div>
    <div
      id="divCheckbox"
      style="visibility: hidden; width: 100%; margin-top: 7rem"
    ></div>

    <footer
      class="w-100 footer mt-auto py-3 bg-light position-fixed bottom-0 start-50 translate-middle-x"
    >
      <div class="container">
        <div class="row">
          <div class="col-8">
            <a href="/">Hlavní</a>
          </div>
          <div id="account" class="col-4">
            <a href="/prihlaseni">Přihlášení</a>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      var questions = [
        {
          question: "",
          answers: [
            {
              answer: "",
              correct: false,
            },
          ],
        },
      ];

      var listenedInputIDs = [];
      function inputListeners() {
        var inputs = document.querySelectorAll("input");
        inputs.forEach((input) => {
          if (!listenedInputIDs.includes(input.id)) {
            if (
              /^q-\d+$/.test(input.id) ||
              /^a-\d+-\d+$/.test(input.id) ||
              /^a-\d+-\d+-correct$/.test(input.id)
            ) {
              input.addEventListener("input", (e) => {
                var splitID = input.id.split("-");
                splitID.shift();
                if (/^q-\d+$/.test(input.id)) {
                  var index = Number(splitID[0]);
                  questions[index].question = input.value;
                } else if (/^a-\d+-\d+$/.test(input.id)) {
                  var index = Number(splitID[0]);
                  var index2 = Number(splitID[1]);
                  questions[index].answers[index2].answer = input.value;
                } else if (/^a-\d+-\d+-correct$/.test(input.id)) {
                  var index = Number(splitID[0]);
                  var index2 = Number(splitID[1]);
                  questions[index].answers[index2].correct = input.checked;
                }
                console.log(questions);
              });
              listenedInputIDs.push(input.id);
            }
          }
        });
      }
      inputListeners();

      function createTemplate() {
        var data = {
          show: $("#template-show").prop("checked"),
          pause: $("#template-pause").prop("checked"),
          roundTime: Number($("#question-time").val()),
          name: $("#template-name").val(),
          questions,
        };
        console.log(data);
        axios
          .post("/api/create-template", data)
          .then(function (res) {
            if (res.data.stav == "redirect") {
              window.location = "/ucet";
            } else if (res.data.stav == "length0") {
              return alertos(
                5000,
                "danger",
                "Nemůžete vytvořit předlohu bez otázek.",
                1000
              );
            } else if (res.data.stav == "missingA") {
              return alertos(
                5000,
                "danger",
                "Nemůžete vytvořit otázku bez odpovědí.",
                1000
              );
            } else if (res.data.stav == "emptyA") {
              return alertos(
                5000,
                "danger",
                "Nemůžete vytvořit prázdnou odpověď.",
                1000
              );
            } else if (res.data.stav == "missingCorrectA") {
              return alertos(
                5000,
                "danger",
                "Nemůžete vytvořit otázku bez správné odpovědi.",
                1000
              );
            } else if (res.data.stav == "missingName") {
              return alertos(
                5000,
                "danger",
                "Nemůžete vytvořit předlohu bez názvu.",
                1000
              );
            } else if (res.data.stav == "negative") {
              return alertos(
                5000,
                "danger",
                "Nemůžete použít záporné číslo.",
                1000
              );
            }
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      function newQuestion() {
        const newIndex = questions.length;

        const html = $.parseHTML(`
      <li id="q-${newIndex}-body" class="list-group-item">
        <div class="d-flex bd-highlight">
          <div class="align-self-center p-2 flex-grow-1 bd-highlight">
            <input id="q-${newIndex}" type="text" class="form-control" placeholder="Otázka" />
            <!-- Odpovědi -->
            <h2 class="fs-5 m-3">Odpovědi</h2>
            <ul id="q-${newIndex}-list" class="m-2 list-group">
              <!-- Odpověď 1 -->
              <li id="a-${newIndex}-0-body" class="list-group-item">
                <div class="d-flex bd-highlight">
                  <div class="align-self-center p-2 flex-grow-1 bd-highlight">
                    <input
                      id="a-${newIndex}-0"
                      type="text"
                      class="form-control"
                      placeholder="Odpověď"
                    />
                    <div class="m-3 form-check">
                      <input
                        id="a-${newIndex}-0-correct"
                        type="checkbox"
                        class="form-check-input"
                      />
                      <label class="form-check-label" for="a-${newIndex}-0-correct"
                        >Správná odpověď</label
                      >
                    </div>
                  </div>
                  <div class="align-self-center p-2 bd-highlight">
                    <button
                      onclick="deleteAnswer(${newIndex}, 0)"
                      class="m-2 btn btn-sm btn-danger"
                    >
                      Smazat
                    </button>
                  </div>
                </div>
              </li>
            </ul>
            <!-- Nová odpověď -->
            <button class="btn btn-sm btn-primary" onclick="newAnswer(${newIndex})">
              Nová odpověď
            </button>
          </div>
          <div class="align-self-center p-2 bd-highlight">
            <button onclick="deleteQuestion(${newIndex})" class="m-2 btn btn-sm btn-danger">
              Smazat
            </button>
          </div>
        </div>
      </li>
                `);
        $("#question-list").append(html);
        questions.push({
          question: "",
          answers: [
            {
              answer: "",
              correct: false,
            },
          ],
        });
        inputListeners();
      }

      function deleteQuestion(index) {
        $(`#q-${index}-body`).remove();
        questions[index] = undefined;
      }

      function newAnswer(index) {
        const newIndex = questions[index].answers.length;
        const html = $.parseHTML(
          `<li id="a-${index}-${newIndex}-body" class="list-group-item">
                <div class="d-flex bd-highlight">
                  <div class="align-self-center p-2 flex-grow-1 bd-highlight">
                    <input
                      id="a-${index}-${newIndex}"
                      type="text"
                      class="form-control"
                      placeholder="Odpověď"
                    />
                    <div class="m-3 form-check">
                      <input
                        id="a-${index}-${newIndex}-correct"
                        type="checkbox"
                        class="form-check-input"
                      />
                      <label class="form-check-label" for="a-${index}-${newIndex}-correct"
                        >Správná odpověď</label
                      >
                    </div>
                  </div>
                  <div class="align-self-center p-2 bd-highlight">
                    <button
                      onclick="deleteAnswer(${index}, ${newIndex})"
                      class="m-2 btn btn-sm btn-danger"
                    >
                      Smazat
                    </button>
                  </div>
                </div>
              </li>`
        );
        $(`#q-${index}-list`).append(html);
        questions[index].answers.push({
          answer: "",
          correct: false,
        });
        inputListeners();
      }

      function deleteAnswer(index, index2) {
        $(`#a-${index}-${index2}-body`).remove();
        questions[index].answers[index2] = undefined;
      }

      axios
        .get("/api/user")
        .then(function (res) {
          if (res.data.username) {
            $("#account").html(`
            <a href="/ucet">${res.data.username}</a>
            -
            <a href="/odhlaseni">Odhlásit</a>`);
          }
        })
        .catch(function (error) {
          console.log(error);
        });

      function alertos(time, type, text, fadeouttime) {
        var div = document.createElement("div");
        var el = $(div);
        el.addClass(["opacity-75", "alert", `alert-${type}`, "m-2"]);
        el.attr("role", "alert");
        el.text(text);
        el.appendTo("#alerts");

        setTimeout(() => {
          el.fadeOut(0.75 * fadeouttime);
          setTimeout(() => {
            el.removeClass("opacity-75");
          }, 0.25 * fadeouttime);
        }, time);
      }
    </script>
  </body>
</html>
