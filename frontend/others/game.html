<!DOCTYPE html>
<html lang="CZ-cs">
  <head>
    <meta charset="UTF-8" />
    <title>Kozooh - Hra</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="../style.css" />
  </head>

  <body class="m-0 bg-bg" style="height: 100vh">
    <header
      class="border-bottom w-100 footer mt-auto py-2 bg-panel top-0 start-50"
      style="height: 7%"
    >
      <div class="container">
        <div class="row">
          <div class="col-8">
            <h3 style="font-size: 3vh">
              <span id="questionCurrent">X</span>/<span id="questionTotal"
                >X</span
              >
              - <span id="timeLast">X</span>
            </h3>
          </div>
          <div class="col-2">
            <h3 id="nickname" style="font-size: 3vh"></h3>
          </div>
          <div class="col-2 align-self-center">
            <h3
              id="coins"
              class="m-0"
              style="font-size: 3vh; display: inline-block"
            ></h3>
            <div
              id="coinIcon"
              class="m-0"
              style="height: 5vh; width: 5vh; display: inline-block"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="100%"
                height="100%"
                fill="currentColor"
                class="bi bi-coin m-0"
                viewbox="0 0 16 16"
              >
                <path
                  d="M5.5 9.511c.076.954.83 1.697 2.182 1.785V12h.6v-.709c1.4-.098 2.218-.846 2.218-1.932 0-.987-.626-1.496-1.745-1.76l-.473-.112V5.57c.6.068.982.396 1.074.85h1.052c-.076-.919-.864-1.638-2.126-1.716V4h-.6v.719c-1.195.117-2.01.836-2.01 1.853 0 .9.606 1.472 1.613 1.707l.397.098v2.034c-.615-.093-1.022-.43-1.114-.9H5.5zm2.177-2.166c-.59-.137-.91-.416-.91-.836 0-.47.345-.822.915-.925v1.76h-.005zm.692 1.193c.717.166 1.048.435 1.048.91 0 .542-.412.914-1.135.982V8.518l.087.02z"
                />
                <path
                  d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"
                />
                <path
                  d="M8 13.5a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11zm0 .5A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"
                />
              </svg>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div
      id="progress"
      style="height: 2%; position: relative; left: 0; width: 100vw"
    ></div>

    <div class="position-fixed end-0" id="alerts"></div>

    <button
      id="startGame"
      onclick="startGame()"
      class="position-absolute top-0 start-0 btn btn-primary btn-lg m-5 visually-hidden"
    >
      START !!!
    </button>

    <div id="screen" class="m-0" style="height: 91%"></div>
    <audio id="audioplayer" loop></audio>

    <div style="display: none">
      <div id="starting">
        <h1 id="game-number" class="fs-0 text-center p-3"></h1>
        <h2 class="fs-4 text-center m-1">kozooh.kozohorsky.xyz</h2>
        <div
          id="player-list"
          class="mt-2 mb-2"
          style="width: 80%; margin-left: 10%; margin-right: 10%; height: 80%"
        ></div>
      </div>
      <div id="question-hidden">
        <div
          id="button-list"
          class="m-0"
          style="width: 100%; height: 93%"
        ></div>
      </div>
      <div id="question-showed">
        <div class="m-0" style="width: 100%; height: 43%">
          <h2 id="question-text" class="text-center p-5"></h2>
        </div>
        <div
          id="button-list"
          class="m-0"
          style="width: 100%; height: 45%"
        ></div>
      </div>
      <div id="countdown">
        <h1
          id="countdown-time"
          class="text-center"
          style="
            font-size: 5rem;
            height: 16%;
            width: 16%;
            top: 42%;
            left: 42%;
            position: absolute;
            margin: 0;
          "
        >
          5
        </h1>
      </div>
      <div id="pause">
        <ol
          id="position-list"
          class="list-group list-group-numbered m-4 fs-4"
        ></ol>
      </div>
      <div id="waiting">
        <div style="width: 100%; height: 100%">
          <div
            style="
              top: 40vh;
              left: calc((100vw - 20vh) / 2);
              width: 20vh;
              height: 20vh;
              margin: 0;
              position: absolute;
            "
          >
            <img
              src="https://images.squarespace-cdn.com/content/v1/5a098dc49f8dced56201c0a0/1602935513880-HEZ0OVFT9UZGR0CLO55U/stopwatch.gif?format=1000w"
              alt=""
              width="100%"
              height="100%"
            />
          </div>
        </div>
      </div>
      <div id="evaluation">
        <div style="width: 100%; height: 100%">
          <div style="width: 60%; margin: auto">
            <ol
              id="winner-list"
              class="list-group list-group-numbered m-4 fs-4"
            ></ol>

            <ol
              id="question-list"
              class="list-group list-group-numbered m-4 fs-4"
            ></ol>

            <a href="#" id="xlsx" class="text-center m-2 fs-5"
              >Stáhnout výsledky v .xlsx</a
            >
          </div>
        </div>
      </div>
      <div id="result">
        <div style="width: 100%; height: 100%">
          <div
            class="align-self-center"
            style="
              top: 40vh;
              left: calc((100vw - 20vh) / 2);
              margin: 0;
              width: 20vh;
              height: 20vh;
              position: absolute;
            "
          >
            <img id="resIcon" style="width: 100%; height: 100%" />
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      $("#screen").html($("#starting").html());
      const gameID = window.location.pathname.substring(1, 7);
      $("#game-number").text(gameID);
      var queryDict = {};
      var role = "";
      var interval = null;
      var intervalTime = 0;
      location.search
        .substr(1)
        .split("?")
        .forEach(function (item) {
          queryDict[item.split("=")[0]] = item.split("=")[1];
        });

      const socket = io(window.location.origin);
      socket.on("connect", () => {
        axios
          .post("/api/game-auth", {
            sid: socket.id,
            gameID,
          })
          .then(function (res) {})
          .catch(function (error) {
            console.log(error);
          });
      });

      socket.on("screen", async (screen) => {
        console.log(screen);
        if (screen.is == "STARTING") {
          stopInterval();
          $("#screen").html($("#starting").html());
          $("#game-number").text(gameID);
          screen.guests.forEach((g) => {
            var html = $.parseHTML(`
                <div
                  class="m-3 border border-secondary rounded-1 d-inline-flex flex-nowrap bd-highlight"
                >
                  <h3 class="fs-4 bg-light px-4 py-1 m-0">${g.nickname}</h3>
                </div>`);

            $("#player-list").append(html);
          });
        } else if (screen.is == "COUNTDOWN") {
          stopInterval();
          $("#screen").html($("#countdown").html());
          $("#countdown-time").text(screen.time);
          $("#questionTotal").text(screen.totalQ);
          $("#questionCurrent").text(screen.questionID);
        } else if (screen.is == "QUESTION-SHOWED") {
          runInterval(screen.roundTime);
          $("#screen").html($("#question-showed").html());
          $("#question-text").text(screen.question);
          var type = ["primary", "danger", "success", "warning"];
          screen.answers.forEach((a, i) => {
            var html = $.parseHTML(`
                  <div id="aBtn${i}"
                class="d-inline-flex flex-nowrap bd-highlight"
                style="width: 46%; height: 46%; margin: 1.5%"
              >
                <button onclick="questionClick(${i})" class="btn btn-${type[i]} btn-lg w-100 h-100">${a}</button>
              </div>`);
            $("#button-list").append(html);
          });
          if (role == "CONTROL") {
            var audio = document.getElementById("audioplayer");
            function getRndInteger(min, max) {
              return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            var url = "./others/audio/" + getRndInteger(0, 5) + ".mp3";

            audio.src = url;

            audio.oncanplay = function () {
              audio.play();
            };
            audio.load();
          }
        } else if (screen.is == "QUESTION-HIDDEN") {
          if (role == "CONTROL") return;
          runInterval(screen.roundTime);
          $("#screen").html($("#question-hidden").html());
          var type = ["primary", "danger", "success", "warning"];
          for (let i = 0; i < screen.answers.length; i++) {
            var html = $.parseHTML(`
                  <div
                class="d-inline-flex flex-nowrap bd-highlight"
                style="width: 46%; height: 46%; margin: 1.5%"
              >
                <button onclick="questionClick(${i})" class="btn btn-${type[i]} btn-lg w-100 h-100"></button>
              </div>`);
            $("#button-list").append(html);
          }
        } else if (screen.is == "PAUSE") {
          stopInterval();
          document.getElementById("audioplayer").pause();
          $("#screen").html($("#pause").html());
          screen.guests.forEach((g, i) => {
            var html = $.parseHTML(`
                  <li
                  class="list-group-item d-flex justify-content-between align-items-start"
                >
                  <div class="ms-2 me-auto">
                    <div class="fw-bold">${g.nickname}</div>
                  </div>
                  <span class="badge bg-primary rounded-pill">${g.coins}</span>
                </li>`);
            $("#position-list").append(html);
          });
          if (role != "CONTROL") {
            $("#coins").text(
              screen.guests.find((x) => x.nickname == $("#nickname").text())
                .coins
            );
          }
        } else if (screen.is == "EVALUATION") {
          stopInterval();
          document.getElementById("audioplayer").pause();
          $("#screen").html($("#evaluation").html());
          screen.average.questions.forEach((q, qi) => {
            var answers = "";
            q.answers.forEach((a, ai) => {
              answers =
                answers +
                "\n" +
                `
                    <li
                            class="list-group-item justify-content-between align-items-start"
                          >
                            <h3 class="fs-5 m-3">${a.answer}</h3>
                            <div class="progress">
                              <div
                                class="progress-bar bg-${
                                  a.correct ? "success" : "danger"
                                }"
                                role="progressbar"
                                style="width: ${a.percent}%"
                              ></div>
                            </div>
                            <h3 class="fs-4 m-2">${a.votes}/${
                  screen.average.players
                } (${a.percent}%)</h3>
                          </li>
                    `;
            });
            var html = $.parseHTML(`
                  <li
                    class="list-group-item justify-content-between align-items-start"
                  >
                    <h3 class="fs-5 m-3">${q.question}</h3>
                    <div class="ms-2 me-auto w-100">
                      <div>
                        <ul class="list-group m-4 fs-4">
                          ${answers}
                        </ul>
                      </div>
                    </div>
                  </li>
                  `);
            $("#question-list").append(html);
          });
          screen.guests.forEach((g) => {
            var html = $.parseHTML(`
                  <li
                    class="list-group-item d-flex justify-content-between align-items-start"
                  >
                    <div class="ms-2 me-auto">
                      <div class="fw-bold">${g.nickname}</div>
                      <div class="fs-5">${g.correct}/${screen.average.questions.length} (${g.uspesnost}%)</div>
                    </div>
                    <span class="badge bg-primary rounded-pill">${g.coins}</span>
                  </li>
                  `);
            $("#winner-list").append(html);
          });
          $("#xlsx").attr(
            "href",
            window.location.hostname + "/results/" + gameID + ".xlsx"
          );
          if (role != "CONTROL") {
            $("#coins").text(
              screen.guests.find(
                (x) => x.nickname == $("#nickname").text().coins
              )
            );
          }
        } else if (screen.is == "RESULT") {
          if (role != "CONTROL") {
            $("#screen").html($("#result").html());
            $("#resIcon").attr(
              "src",
              screen.correct
                ? "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Eo_circle_light-green_checkmark.svg/2048px-Eo_circle_light-green_checkmark.svg.png"
                : "https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/Cross_red_circle.svg/1200px-Cross_red_circle.svg.png"
            );
          } else {
            for (let i = 0; i <= 3; i++) {
              if (screen.correct != i) {
                $("#aBtn" + i)
                  .attr("disabled", true)
                  .addClass("opacity0");
              }
            }
          }
        }
      });

      function questionClick(index) {
        if (role != "CONTROL") {
          socket.emit("answer", {
            index,
            gameID,
          });
          $("#screen").html($("#waiting").html());
        }
      }

      function startGame() {
        $("#startGame").addClass("visually-hidden");
        socket.emit("start", gameID);
      }

      socket.on("auth", (x) => {
        console.log(x);
        role = x.role;
        if (role == "CONTROL") {
          $("#startGame").removeClass("visually-hidden");
          $("#nickname").remove();
          $("#coins").remove();
          $("#coinIcon").remove();
        } else {
          $("#nickname").text(x.nickname);
          $("#coins").text(x.coins);
        }
      });

      function runInterval(roundTime) {
        var progress = document.getElementById("progress");
        var timeLast = document.getElementById("timeLast");
        interval = setInterval(() => {
          intervalTime += 20;

          var wdth = 100 / (roundTime * 50);
          var width = Number(progress.style["width"].replace("vw", "")) - wdth;
          width = width < 0 ? 0 : width;

          progress.style["width"] = width.toString() + "vw";

          /*

       w: 0% ------------------------ 50% ------------------------ 100%
       r: 255 ----------------------- 255             >              0
       g: 0             <             255 --------------------------255

          */

          var r = width < 100 ? 255 : scaleValue(width, [50, 100], [255, 0]);
          var g = width >= 50 ? 255 : scaleValue(width, [50, 0], [255, 0]);

          progress.style["background-color"] = rgbToHex(r, g, 0);

          if (intervalTime == 1000) {
            timeLast.innerText = (Number(timeLast.innerText) - 1).toString();
          }
        }, 1000 / 50);
      }

      function stopInterval() {
        clearInterval(interval);
        intervalTime = 0;

        document.getElementById("progress").style["background-color"] =
          rgbToHex(239, 245, 245);
      }
      function rgbToHex(r, g, b) {
        return "#" + r.toString(16) + g.toString(16) + b.toString(16);
      }
      function scaleValue(value, from, to) {
        var scale = (to[1] - to[0]) / (from[1] - from[0]);
        var capped = Math.min(from[1], Math.max(from[0], value)) - from[0];
        return ~~(capped * scale + to[0]);
      }

      function alertos(time, type, text, fadeouttime) {
        var div = document.createElement("div");
        var el = $(div);
        el.addClass(["opacity-75", "alert", `alert-${type}`, "m-2"]);
        el.attr("role", "alert");
        el.text(text);
        el.appendTo("#alerts");

        setTimeout(() => {
          el.fadeOut(0.75 * fadeouttime);
          setTimeout(() => {
            el.removeClass("opacity-75");
          }, 0.25 * fadeouttime);
        }, time);
      }
    </script>
  </body>
</html>
